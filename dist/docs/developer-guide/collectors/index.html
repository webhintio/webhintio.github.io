<!doctype html><html lang="en"><head><meta charset="utf-8"><title>How to develop a collector</title><meta name="description" content="sonar website"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#4046dd"><link rel="manifest" href="/site.webmanifest"><link rel="apple-touch-icon" href="/images/apple-touch-icon.png"><link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16"><link rel="stylesheet" href="/core/css/base.css"><link rel="stylesheet" href="/core/css/color.css"><link rel="stylesheet" href="/core/css/footer.css"><link rel="stylesheet" href="/core/css/helpers.css"><link rel="stylesheet" href="/core/css/layouts.css"><link rel="stylesheet" href="/core/css/navigation.css"><link rel="stylesheet" href="/core/css/search-results.css"><link rel="stylesheet" href="/core/css/structure.css"><link rel="stylesheet" href="/core/css/type.css"><link rel="stylesheet" href="/core/css/highlight.css"><link rel="stylesheet" href="/components/breadcrumb/breadcrumb.css"><link rel="stylesheet" href="/core/css/controls.css"><link rel="stylesheet" href="/core/css/code.css"><link rel="stylesheet" href="/core/css/table-of-contents.css"><link rel="stylesheet" href="/core/css/tables-lists.css"><link rel="stylesheet" href="/components/treeview/treeview.css"><link href="https://fonts.googleapis.com/css?family=Montserrat:200,300,400,500,600" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"></head><body><header class="header"><div class="nav-bar container"><nav class="nav"><a href="/" class="clear logo--container"><img src="/images/sonar-logo.svg" alt="sonar" class="header__logo navbar__navitem"></a><ul class="nav__navbar"><li class="navbar__navitem"><a role="button" href="/" id="docs" aria-haspopup="true" aria-expanded="false" aria-controls="submenu-docs" class="navitem__button expandable">Documentation</a><ul role="group" id="submenu-docs" class="navbar__submenu" aria-hidden="true"><li><a href="/docs/developer-guide/">Developer Guide</a></li><li><a href="/docs/user-guide/rules/">Rules</a></li><li><a href="/docs/user-guide/">User Guide</a></li></ul></li><li class="navbar__navitem"><a role="button" href="/" id="about" aria-haspopup="true" aria-expanded="false" aria-controls="submenu-about" class="navitem__button expandable">About</a><ul role="group" id="submenu-about" class="navbar__submenu" aria-hidden="true"><li><a href="/about/faq.html">FAQ</a></li><li><a href="/about/changelog.html">Changelog</a></li><li><a href="/about/governance.html">Governance</a></li><li><a href="/about/contributors.html">Contributors</a></li><li><a href="/about/code_of_conduct.html">Code of Conduct</a></li></ul></li></ul><div class="nav-bar__input"><label for="search-input" class="visually-hidden">Search the documentation</label><input type="search" id="search-input" placeholder="Search…" aria-label="Search"></div></nav><button class="header__toggle mobile-nav-button" aria-label="Menu"></button></div></header><main class="container"><article class="content" aria-labelledby="page-heading"><nav class="container breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/">Home</a></li><li><a href="../../">Documentation</a></li><li><a href="../">Developer guide</a></li><li aria-current="location">How to develop a collector</li></ul></nav><header class="page-intro"><h1 id="page-heading">How to develop a collector</h1></header><section class="section"><div class="layout layout--sidebar"><div class="module module--primary wrap-text"><h1 id="howtodevelopacollector"><a href="#howtodevelopacollector" class="headerlink" title="How to develop a collector"></a>How to develop a collector</h1><p>A collector is the way sonar gets information and exposes it to the rules. Collectors are usually built on top of browsers but that isn’t a strong requirement. For example, one of the official collectors uses <a href="https://github.com/tmpvar/jsdom" target="_blank" rel="external">jsdom</a>.</p><p>A collector exposes the information via events, so as long as they are correct, the underlying technology doesn’t matter. Also, you could have more “specialized” collectors that do not implement the full set of events. For example, if you have a collector that only takes into account HTML files from the file system, it could decide not to implement events such as <code>fetch::end</code>.</p><p>This is the <a href="./events.html">list of events supported by sonar</a>. For a collector to be considered “full”, it needs to send all these events. Additionally it needs to pass all the <a href="#how-to-test-a-full-collector">commont tests</a>.</p><h2 id="developa“full”collector"><a href="#developa“full”collector" class="headerlink" title="Develop a “full” collector"></a>Develop a “full” collector</h2><p>A collector needs to implemnet the <a href="https://github.com/sonarwhal/sonar/blob/master/src/lib/types/collector.ts" target="_blank" rel="external"><code>ICollector</code> interface</a></p><p>The entry point to scan a url is <code>collect</code>, that is an <code>async</code> method. Once this method is invoked the following events should be fired in this order:</p><ol><li><a href="./events.html#scanstart"><code>scan::start</code></a></li><li><a href="./events.html#targetfetchstart"><code>targetfetch::start</code></a><ul><li>If there is an error, send <a href="./events.html#targetfetcherror"><code>targetfetch::error</code></a> follow by <a href="./events.html#targetfetchend"><code>scan::end</code></a>.</li></ul></li><li><a href="./events.html#targetfetchend"><code>targetfetch::end</code></a></li><li>Once the content is downloaded, network requests for different resources (CSS, JS, etc.) are performed. Depending on the collector, they will be downloaded at one moment or another (critical path, capable of parse HTML as a stream, etc.). The events for these resources are:<ul><li><a href="./events.html#fetchstart"><code>fetch::start</code></a></li><li><a href="./events.html#fetchend"><code>fetch::end</code></a></li><li><a href="./events.html#fetcherror"><code>fetch::error</code></a></li></ul></li><li><a href="./events.html#traversestart"><code>traverse::start</code></a> Collectors should wait for the <code>onload</code> event and make sure that “everything is quiet”: there aren’t any pending network requests or if there are, the collector has waited a reasonable amount of time. The traversing of the DOM is <a href="https://en.wikipedia.org/wiki/Depth-first_search" target="_blank" rel="external">depth-first</a>, sending:<ul><li><a href="./events.html#elementelement-type"><code>element::&lt;element-type&gt;</code></a> when visiting a node (see <a href="#iasynchtml">IASyncHTML</a> for more information,</li><li><a href="./events.html#traversedown"><code>traverse::down</code></a> when going deeper in the DOM,</li><li><a href="./events.html#traverse::up"><code>traverse::up</code></a> when going up.</li></ul></li><li><a href="./events.html#traverse::end"><code>traverse::end</code></a></li><li>Before sending the final event, the collector needs to try to download the web manifest: to download the manifest automatically and send the following events:<ul><li><a href="./events.html#manifestfetchend"><code>manifestfetch::end</code></a> with the content of the manifest,</li><li><a href="./events.html#manifestfetchend"><code>manifestfetch::error</code></a> if there has been an error downloading the manifest,</li><li><a href="./events.html#manifestfetchend"><code>manifestfetch::missing</code></a> if no manifest is specified.</li></ul></li><li>The final event is <a href="./events.html#scanend"><code>scan::end</code></a>.</li></ol><p>For more details about how the events look like and the properties they should implement, visit the <a href=",/.events.html">events page</a>.</p><p>Also, collectors need to expose some methods:</p><figure class="highlight ts"><table><tr><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ICollector &#123;</div><div class="line">    <span class="comment">/** The original DOM of the resource collected. */</span></div><div class="line">    dom: object;</div><div class="line">    <span class="comment">/** The original HTML of the resource collected. */</span></div><div class="line">    html: <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt;;</div><div class="line">    <span class="comment">/** The headers from the response if applicable. */</span></div><div class="line">    headers: object;</div><div class="line">    <span class="comment">/** Collects all the information for the given target. */</span></div><div class="line">    collect(target: url.Url): <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;; <span class="comment">// <span class="doctag">TODO:</span> TS doesn't detect correctly `pify` promises</span></div><div class="line">    <span class="comment">/** Releases any used resource and/or browser. */</span></div><div class="line">    close(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt;;</div><div class="line">    <span class="comment">/** Download an external resource using ` customHeaders` if needed. */</span></div><div class="line">    fetchContent(target: URL | <span class="built_in">string</span>, customHeaders?: object): <span class="built_in">Promise</span>&lt;INetworkData&gt;;</div><div class="line">    <span class="comment">/** Evaluates the given JavaScript `code` asynchronously in the target. */</span></div><div class="line">    evaluate(code: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;;</div><div class="line">    <span class="comment">/** Finds all the nodes that match the given query. */</span></div><div class="line">    querySelectorAll(query: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">Array</span>&lt;IAsyncHTMLElement&gt;&gt;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="iasynchtml"><a href="#iasynchtml" class="headerlink" title="IASyncHTML"></a>IASyncHTML</h3><p>IAsyncHTML is an abstraction on top of the <code>collector</code>‘s DOM. The reason is that some <code>collector</code>s can access the DOM synchronously (like <code>jsdom</code>) and some others don’t (like those that rely on a debugging protocol). We decided to create an asynchronous abstraction so the different parts that might need access to the DOM know how to use. <code>IAsyncHTML</code> is composed two interfaces: <code>IAsyncHTMLElement</code> and <code>IAsyncHTMLDocument</code>. Not all the <code>HTMLElement</code> or <code>HTMLDocument</code> properties are implemented:</p><figure class="highlight ts"><table><tr><td class="code"><pre><div class="line"><span class="comment">/** A wrapper of an HTMLElement that gives access to the required resources</span></div><div class="line">  * asynchronously to be compatible with all collectors */</div><div class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IAsyncHTMLElement &#123;</div><div class="line">    <span class="comment">/** The attributes of the element */</span></div><div class="line">    readonly attributes: <span class="built_in">Array</span>&lt;&#123; name: <span class="built_in">string</span>, value: <span class="built_in">string</span> &#125;&gt; | NamedNodeMap;</div><div class="line">    <span class="comment">/** Returns the value for a given attribute */</span></div><div class="line">    getAttribute(attribute: <span class="built_in">string</span>): <span class="built_in">string</span>;</div><div class="line">    <span class="comment">/** Checks if two AsyncHTMLElements are the same */</span></div><div class="line">    isSame(element: IAsyncHTMLElement): <span class="built_in">boolean</span>;</div><div class="line">    <span class="comment">/** Returns the outerHTML of the element */</span></div><div class="line">    outerHTML(): <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt;;</div><div class="line">    <span class="comment">/** Returns the document where the element lives */</span></div><div class="line">    readonly ownerDocument: IAsyncHTMLDocument;</div><div class="line">    <span class="comment">/** The nodeName of the element */</span></div><div class="line">    readonly nodeName: <span class="built_in">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IAsyncHTMLDocument &#123;</div><div class="line">    <span class="comment">/** A wrapper around querySelectorAll that returns an Array of AsyncHTMLElements instead of a NodeList */</span></div><div class="line">    querySelectorAll(selector: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">Array</span>&lt;IAsyncHTMLElement&gt;&gt;</div><div class="line">    <span class="comment">/** The HTML of the page as returned by document.children[0].outerHTML or similar */</span></div><div class="line">    pageHTML(): <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>When traversing the DOM, the <code>element</code> in the <code>event</code> needs to be an <code>IAsyncHTMLElement</code>.</p><h2 id="howtotesta“full”collector"><a href="#howtotesta“full”collector" class="headerlink" title="How to test a “full” collector"></a>How to test a “full” collector</h2><p>To make sure your collector is a “full” collector, it has to pass the following tests:</p><ol><li><code>/tests/lib/collectors/events.ts</code> verifies the basic event interaction, redirects, right results, etc.</li><li><code>/tests/lib/collectors/evaluate.ts</code> makes sure the collector can execute external JavaScript.</li><li><code>/tests/lib/rules/**/*</code> all rules tests should pass.</li></ol></div><div class="module module--secondary table-of-contents treeview" role="navigation"><ul role="tree" aria-labelledby="page-heading" tabindex="0"><li role="treeitem" aria-label="subsection" tabindex="0" aria-expanded="true"><div class="toc-section-title--active"><span class="text">collectors</span> <span class="icon"></span></div><ul role="group"><li role="treeitem" aria-selected="true"><div class="toc-subsection-title--active" aria-current="location"><a class="text" href="/docs/developer-guide/collectors/index.html">How to develop a collector</a></div></li><li role="treeitem"><div class="toc-subsection-title"><a class="text" href="/docs/developer-guide/collectors/events.html">Events</a></div></li></ul></li><li role="treeitem" aria-label="subsection" tabindex="0" aria-expanded="false"><div class="toc-section-title"><span class="text">formatters</span> <span class="icon"></span></div><ul role="group"><li role="treeitem"><div class="toc-subsection-title"><a class="text" href="/docs/developer-guide/formatters/index.html" tabindex="-1">How to develop a formatter</a></div></li></ul></li><li role="treeitem" aria-label="subsection" tabindex="0" aria-expanded="false"><div class="toc-section-title"><span class="text">rules</span> <span class="icon"></span></div><ul role="group"><li role="treeitem"><div class="toc-subsection-title"><a class="text" href="/docs/developer-guide/rules/index.html" tabindex="-1">How to develop a rule</a></div></li></ul></li></ul></div></div></section></article></main><footer class="footer footer--home"><div class="footer-nav container"><div class="footer-nav__item"><p class="category">Documentation</p><ul><li><a href="/docs/developer-guide/">Developer Guide</a></li><li><a href="/docs/user-guide/rules/">Rules</a></li><li><a href="/docs/user-guide/">User Guide</a></li></ul></div><div class="footer-nav__item"><p class="category">About</p><ul><li><a href="/about/faq.html">FAQ</a></li><li><a href="/about/changelog.html">Changelog</a></li><li><a href="/about/governance.html">Governance</a></li><li><a href="/about/contributors.html">Contributors</a></li><li><a href="/about/code_of_conduct.html">Code of Conduct</a></li></ul></div><ul class="footer-nav__item social-list"><li class="github-icon"><a href="https://github.com/sonarwhal" aria-label="Follow Sonar on GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25"><path class="github-icon-svg" d="M12.5.4C5.7.4.2 5.9.2 12.7c0 5.4 3.5 10 8.4 11.7.6.1.8-.3.8-.6v-2.1C6 22.4 5.3 20 5.3 20c-.6-1.4-1.4-1.8-1.4-1.8-1.1-.7.1-.7.1-.7 1.2.1 1.9 1.3 1.9 1.3 1.1 1.9 2.9 1.3 3.6 1 .1-.8.4-1.3.8-1.6-2.7-.3-5.6-1.4-5.6-6.1 0-1.3.5-2.4 1.3-3.3-.2-.4-.6-1.6 0-3.3 0 0 1-.3 3.4 1.3 1-.3 2-.4 3.1-.4 1 0 2.1.1 3.1.4C17.9 5.2 19 5.5 19 5.5c.7 1.7.2 2.9.1 3.3.8.9 1.3 2 1.3 3.3 0 4.7-2.9 5.8-5.6 6.1.4.4.8 1.1.8 2.3v3.4c0 .3.2.7.8.6 4.9-1.6 8.4-6.2 8.4-11.7C24.8 5.9 19.3.4 12.5.4"/></svg></a></li><li class="twitter-icon"><a href="https://twitter.com/narwhalnellie" aria-label="Follow Sonar on Twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 24"><path class="twitter-icon-svg" d="M25 4.4c-.9.4-1.9.7-2.9.8 1-.6 1.8-1.6 2.2-2.8-1 .6-2.1 1-3.2 1.2-.9-1-2.2-1.6-3.7-1.6-2.8 0-5 2.3-5 5 0 .4 0 .8.1 1.2C8.3 8 4.6 6 2.1 2.9c-.4.8-.7 1.6-.7 2.6 0 1.8.9 3.3 2.2 4.2-.8-.1-1.5-.3-2.2-.7v.1c0 2.4 1.7 4.5 4.1 5-.4.1-.9.2-1.3.2-.3 0-.6 0-.9-.1.6 2 2.5 3.5 4.7 3.5-1.9 1.3-4 2.1-6.4 2.1-.4 0-.8 0-1.2-.1C2.6 21.2 5.3 22 8.1 22c9.3 0 14.4-7.7 14.4-14.4v-.7c1-.6 1.8-1.5 2.5-2.5"/></svg></a></li></ul></div></footer><script src="/js/nav.js"></script><script src="/core/scripts/form-validation.js"></script><script src="/components/accordion/accordion.js"></script><script src="/components/treeview/treeview.js"></script><script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script><script>docsearch({apiKey:"2ee58f908e6d720c4f72a9645ce0e857",indexName:"sonarwhal",inputSelector:"#search-input",appId:"0R8E5SPAFP",debug:!1})</script><script>!function(e,t,a,c,n){e.GoogleAnalyticsObject=a,e[a]||(e[a]=function(){(e[a].q=e[a].q||[]).push(arguments)}),e[a].l=+new Date,c=t.createElement("script"),n=t.scripts[0],c.src="https://www.google-analytics.com/analytics.js",n.parentNode.insertBefore(c,n)}(this,document,"ga"),ga("create","UA-101540923-1"),ga("send","pageview")</script></body></html>